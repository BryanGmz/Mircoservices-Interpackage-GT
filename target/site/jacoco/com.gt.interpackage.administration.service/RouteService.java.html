<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RouteService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">administration</a> &gt; <a href="index.source.html" class="el_package">com.gt.interpackage.administration.service</a> &gt; <span class="el_source">RouteService.java</span></div><h1>RouteService.java</h1><pre class="source lang-java linenums">package com.gt.interpackage.administration.service;

import com.gt.interpackage.administration.model.Route;
import com.gt.interpackage.administration.repository.RouteRepository;
import com.gt.interpackage.administration.source.BadRequestException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

@Service
<span class="nc" id="L16">public class RouteService {</span>

    @Autowired
    private RouteRepository routeRepository;

    /**
     * Metodo que llama al repositorio de rutas para consultar si existe una
     * ruta cuyo id sea el  parametro que se recibe.
     * @param id
     * @return True o False.
     */
    public boolean existsById(Long id){
<span class="nc" id="L28">        return routeRepository.existsById(id);</span>
    }

    public Route create(Route route, DestinationService destinationService) throws BadRequestException {
<span class="nc" id="L32">        this.validateRouteData(route, destinationService);</span>
<span class="nc" id="L33">        return routeRepository.save(route);</span>
    }

    public Route update(Route route, DestinationService destinationService) throws BadRequestException{
<span class="nc" id="L37">        this.validateRouteData(route, destinationService);</span>
<span class="nc" id="L38">        Route updatedRoute = this.getRouteById(route.getId());</span>
<span class="nc" id="L39">        this.validateNoPackagesOnRoute(updatedRoute);</span>
<span class="nc" id="L40">        updatedRoute.setName(route.getName());</span>
<span class="nc" id="L41">        updatedRoute.setActive(route.getActive());</span>
<span class="nc" id="L42">        updatedRoute.setDestination(route.getDestination());</span>
<span class="nc" id="L43">        return routeRepository.save(route);</span>
    }

    public void delete(Long id, CheckpointService checkpointService) throws BadRequestException{
<span class="nc" id="L47">        Route tempRoute = this.getRouteById(id);</span>

<span class="nc bnc" id="L49" title="All 2 branches missed.">        if(checkpointService.routeHasCheckpointsAssigned(id))</span>
<span class="nc" id="L50">            throw  new BadRequestException(&quot;No se puede eliminar la ruta ya que tiene puntos de control asignados.&quot;);</span>

<span class="nc" id="L52">        this.validateNoPackagesOnRoute(tempRoute);</span>
<span class="nc" id="L53">        routeRepository.delete(tempRoute);</span>
<span class="nc" id="L54">    }</span>

    public Page&lt;Route&gt; getAll(int page, int size){
<span class="nc" id="L57">        return routeRepository.findAll(PageRequest.of(page, size, Sort.by(&quot;name&quot;)));</span>
    }

    public Optional&lt;List&lt;Route&gt;&gt; getAllByName(String name){
<span class="nc" id="L61">        return routeRepository.findByNameStartingWith(name);</span>
    }

    public boolean existsByName(String name){
<span class="nc" id="L65">        return routeRepository.existsRouteByName(name);</span>
    }

    public boolean existsAndIdIsNot(String name, Long id){
<span class="nc" id="L69">        return routeRepository.existsRouteByNameAndIdIsNot(name, id);</span>
    }

    public Route getRouteById(Long id) throws BadRequestException{
<span class="nc" id="L73">        Optional&lt;Route&gt; route = routeRepository.findById(id);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if(route.isEmpty())</span>
<span class="nc" id="L75">            throw  new BadRequestException(&quot;La ruta no existe en el sistema.&quot;);</span>
<span class="nc" id="L76">        return route.get();</span>
    }

    public boolean routeHasDestinationAssigned(Long destinationId){
<span class="nc" id="L80">        return routeRepository.existsRouteByDestinationId(destinationId);</span>
    }

    private void validateRouteData(Route route, DestinationService destinationService) throws BadRequestException{
<span class="nc bnc" id="L84" title="All 4 branches missed.">        if(route.getName().isBlank() || route.getName().isEmpty())</span>
<span class="nc" id="L85">            throw new BadRequestException(&quot;Nombre de ruta no valido&quot;);</span>

<span class="nc bnc" id="L87" title="All 2 branches missed.">        if(this.existsAndIdIsNot(route.getName(), route.getId()))</span>
<span class="nc" id="L88">            throw new BadRequestException(&quot;Nombre de ruta ya registrado en el sistema&quot;);</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">        if(destinationService.getDestinationById(route.getDestination().getId()) == null)</span>
<span class="nc" id="L91">            throw new BadRequestException(&quot;El destino indicado no existe en el sistema&quot;);</span>
<span class="nc" id="L92">    }</span>

    private void validateNoPackagesOnRoute(Route route) throws BadRequestException{
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if(route.getPackagesOnRoute() &gt; 0)</span>
<span class="nc" id="L96">            throw new BadRequestException(&quot;No se pueden realizar acciones sobre una ruta que contiene paquetes en ruta.&quot;);</span>
<span class="nc" id="L97">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>